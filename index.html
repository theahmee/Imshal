<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Imshal's Midnight Bloom</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        :root { --maroon: #5e0000; --sea-green: #004d4d; --gold: #c5a059; }
        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            touch-action: none; /* Disables zoom/scroll for instant tapping */
            -webkit-tap-highlight-color: transparent; 
            user-select: none;
        }
        
        body { background: #050505; font-family: 'Cinzel', serif; color: white; overflow: hidden; height: 100vh; position: fixed; width: 100%; }
        
        #ui { position: absolute; top: 40px; width: 100%; text-align: center; z-index: 10; pointer-events: none; }
        .score-display { font-size: 4rem; font-weight: 700; color: var(--gold); opacity: 0.2; letter-spacing: 10px; }
        
        .overlay { 
            position: absolute; width: 100%; height: 100%; display: flex; 
            flex-direction: column; align-items: center; justify-content: center; 
            z-index: 100; background: rgba(0,0,0,0.98); text-align: center; padding: 20px;
        }
        
        #recoveryScreen { background: rgba(0, 15, 15, 0.98); display: none; }
        
        .revive-btn {
            width: 120px; height: 120px; background: var(--maroon); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 3rem;
            box-shadow: 0 0 30px var(--maroon); animation: pulse 0.5s infinite; margin: 30px;
            cursor: pointer;
        }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.1);} 100% {transform: scale(1);} }

        .title { font-size: 3.5rem; color: var(--sea-green); font-family: 'Great Vibes', cursive; }
        .btn { 
            background: none; border: 1px solid var(--maroon); color: var(--gold); 
            padding: 15px 45px; font-family: 'Cinzel'; font-size: 1rem;
            cursor: pointer; letter-spacing: 3px; text-transform: uppercase;
        }

        canvas { display: block; touch-action: none; }
    </style>
</head>
<body>

    <div id="ui"><div class="score-display" id="score">0</div></div>

    <div id="startScreen" class="overlay">
        <h1 class="title">Imshal</h1>
        <p style="color:var(--gold); letter-spacing:5px; margin-bottom:30px; font-size: 0.8rem;">Midnight Bloom</p>
        <button class="btn" id="realStartBtn">Begin</button>
    </div>

    <div id="recoveryScreen" class="overlay">
        <h2 style="font-family: 'Great Vibes'; font-size: 2.5rem; color: var(--gold);">Don't let the garden fade!</h2>
        <p style="font-size: 0.7rem; letter-spacing: 2px; margin-bottom: 20px; color: var(--sea-green);">TAP QUICKLY TO REVIVE</p>
        <div class="revive-btn" id="reviveTap">‚ù§Ô∏è</div>
        <p id="reviveTimer" style="font-family: monospace; color: white; font-size: 1.5rem;"></p>
    </div>

    <div id="gameOver" class="overlay" style="display:none;">
        <h2 style="font-family: 'Great Vibes'; font-size: 3rem; color: var(--maroon);">The Bloom Fades</h2>
        <p id="finalMsg" style="letter-spacing: 2px; margin: 20px 0; color: var(--gold);"></p>
        <button class="btn" onclick="location.reload()">Bloom Again</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const WEBHOOK_URL = "https://discord.com/api/webhooks/1468672631699149064/g8hJ_mzumvcHy3oJ2SUiU2H_XE2jdV0kPG0FQtLNQ0X9D79hehque_cdUH-nA58s7RAS";

        let score = 0, active = false, flowers = [], particles = [];
        let canRevive = true, reviveTaps = 0, reviveTimeLeft = 3;
        let spawnTimer;

        // --- Audio Context Unlock ---
        let audioCtx;
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playSfx(f, type='sine') {
            if(!audioCtx) return;
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = type; o.frequency.setValueAtTime(f, audioCtx.currentTime);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.4);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + 0.4);
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        function start() {
            initAudio();
            score = 0; scoreEl.innerText = score;
            active = true; flowers = []; particles = []; canRevive = true;
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('recoveryScreen').style.display = 'none';
            
            if(spawnTimer) clearTimeout(spawnTimer);
            spawn(); 
            requestAnimationFrame(animate);
            fetch(WEBHOOK_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({content: "üåë Imshal started her Midnight Bloom!"})});
        }

        function spawn() {
            if(!active) return;
            flowers.push({
                x: Math.random() * (canvas.width - 80) + 40,
                y: Math.random() * (canvas.height - 120) + 60,
                r: 75, 
                color: Math.random() > 0.5 ? '#004d4d' : '#5e0000'
            });
            spawnTimer = setTimeout(spawn, Math.max(380, 950 - (score * 12)));
        }

        function animate() {
            if(!active) return;
            ctx.fillStyle = 'rgba(5, 5, 5, 0.25)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            for (let i = flowers.length - 1; i >= 0; i--) {
                let f = flowers[i];
                f.r -= 0.7 + (score * 0.012); // Faster shrinking
                
                ctx.beginPath();
                ctx.strokeStyle = f.color;
                ctx.lineWidth = 3;
                ctx.arc(f.x, f.y, Math.max(0, f.r), 0, Math.PI*2);
                ctx.stroke();

                if(f.r <= 2) {
                    flowers.splice(i, 1);
                    triggerFail();
                }
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.03;
                ctx.fillStyle = p.c; ctx.globalAlpha = p.life;
                ctx.fillRect(p.x, p.y, 3, 3);
                if(p.life <= 0) particles.splice(i, 1);
            }
            ctx.globalAlpha = 1;
            requestAnimationFrame(animate);
        }

        function triggerFail() {
            if(canRevive) {
                active = false;
                canRevive = false;
                reviveTaps = 0;
                reviveTimeLeft = 3.0;
                document.getElementById('recoveryScreen').style.display = 'flex';
                
                const timerInterval = setInterval(() => {
                    reviveTimeLeft -= 0.1;
                    document.getElementById('reviveTimer').innerText = Math.max(0, reviveTimeLeft).toFixed(1) + "s";
                    if(reviveTimeLeft <= 0) {
                        clearInterval(timerInterval);
                        if(!active) endGame();
                    }
                    if(active) clearInterval(timerInterval);
                }, 100);
            } else {
                endGame();
            }
        }

        // --- INSTANT TOUCH SENSITIVITY ---
        const handleInteraction = (e) => {
            if(!active) return;
            // Get coordinates for both touch and mouse
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            for (let i = flowers.length - 1; i >= 0; i--) {
                let f = flowers[i];
                const dist = Math.hypot(clientX - f.x, clientY - f.y);
                // Increased hit area (70) so she doesn't have to be perfect
                if(dist < 70) {
                    score++;
                    scoreEl.innerText = score;
                    playSfx(880 + (score % 10 * 20), 'sine');
                    for(let j=0; j<12; j++) {
                        particles.push({
                            x: f.x, y: f.y, 
                            vx: (Math.random()-0.5)*12, 
                            vy: (Math.random()-0.5)*12, 
                            life: 1, c: f.color
                        });
                    }
                    flowers.splice(i, 1);
                    return; // One tap = one flower
                }
            }
        };

        // Pointerdown is the fastest event for modern mobile browsers
        canvas.addEventListener('pointerdown', handleInteraction);

        document.getElementById('reviveTap').addEventListener('pointerdown', () => {
            reviveTaps++;
            playSfx(400 + (reviveTaps * 150), 'triangle');
            if(reviveTaps >= 5) {
                document.getElementById('recoveryScreen').style.display = 'none';
                active = true;
                flowers = [];
                requestAnimationFrame(animate);
                spawn();
            }
        });

        document.getElementById('realStartBtn').addEventListener('click', start);

        function endGame() {
            active = false;
            document.getElementById('recoveryScreen').style.display = 'none';
            document.getElementById('gameOver').style.display = 'flex';
            document.getElementById('finalMsg').innerText = `SCORE: ${score}`;
            fetch(WEBHOOK_URL, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({content: `ü•Ä Final Score: ${score}`})});
        }
    </script>
</body>
</html>